#!/usr/bin/env python
"""Main script to monitor system resources"""

import argparse
import logging
import os

from benchmon.run import RunMonitor

JOBID = os.getenv("SLURM_JOB_ID") or os.getenv("OAR_JOB_ID") or ""
HOSTNAME = os.uname()[1]
PID = os.getpid()


def parse_args():
    """
    Parse benchmon-run arguments

    Returns:
        argaprse.ArgumentParser Argument namespace
    """
    parser = argparse.ArgumentParser(formatter_class=argparse.RawTextHelpFormatter)

    # add arguments
    parser.add_argument(
        "-d",
        "--save-dir",
        default=f"{os.getcwd()}/benchmon_traces_{JOBID}",
        help="Base directory where metrics will be saved"
    )

    parser.add_argument(
        "-v",
        "--verbose",
        action="store_true",
        default=False,
        help="Enable verbose mode. Display debug messages"
    )

    parser.add_argument(
        "--system",
        "--sys",
        action="store_true",
        help="Enable system monitoring"
    )

    parser.add_argument(
        "--sys-freq",
        type=int,
        default=10,
        help="System monitoring frequency. Default: 10 Hz"
    )

    parser.add_argument(
        "--timing-mapping",
        "--tm",
        action="store_true",
        help="Enable processes timing mapping"
    )

    parser.add_argument(
        "--timing-mapping-frequency",
        "--tm-freq",
        type=float,
        default=10,
        help="Processes timing mapping frequency"
    )

    parser.add_argument(
        "--timing-mapping-ppid",
        "--tm-ppid",
        type=int,
        help="Parent PID to watch for processes timing mapping"
    )

    parser.add_argument(
        "--timing-mapping-mapping",
        "--tm-m",
        action="store_true",
        help="Enable mapping for processes timing mapping"
    )

    parser.add_argument(
        "--power",
        "--pow",
        action="store_true",
        help="Enable power monitoring"
    )

    parser.add_argument(
        "--power-sampling-interval",
        "--pow-sampl-intv",
        type=int,
        default=250,
        help="Sampling interval to collect power metrics. Default value is 250 milliseconds"
    )

    parser.add_argument(
        "--power-g5k",
        "--pow-g5k",
        action="store_true",
        help="Download grid5000 power monitoring"
    )

    parser.add_argument(
        "--call",
        action="store_true",
        help="Enable callstack tracing"
    )

    parser.add_argument(
        "--call-mode",
        type=str,
        default="dwarf,32",
        help="Call graph collection mode (dwarf, lbr, fp). Default: dwarf"
    )

    parser.add_argument(
        "--call-profiling-frequency",
        "--call-prof-freq",
        type=int,
        default=10,
        help="Profiling frequency. Default: 10 Hz"
    )

    parser.add_argument(
        "--call-keep-datafile",
        action="store_true",
        help="Keep perf data file"
    )

    return parser.parse_args()


def get_benchmon_pid(logger: logging.Logger) -> None:
    """
    Get benchmon-run pid
    """
    filename = f"./.benchmon-run_pid_{JOBID}_{HOSTNAME}"
    with open(filename, "w") as fn:
        fn.write(f"{PID}")

    logger.debug(f"PID file created: {filename}")


def create_logger(save_dir: str, verbose: bool) -> logging.Logger:
    """
    Create logging manager
    """
    logger = logging.getLogger("benchmon_logger")
    logger.setLevel(logging.DEBUG)

    fmt = f"<%(filename)s> [{HOSTNAME}] [%(asctime)s] [%(levelname)s] %(message)s"
    datefmt = "%Y-%m-%d %H:%M:%S"
    fmtter = logging.Formatter(fmt=fmt, datefmt=datefmt)

    file_handler = logging.FileHandler(f"{save_dir}/benchmon_{HOSTNAME}.log")
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(fmtter)

    stream_handler = logging.StreamHandler()
    stream_handler.setLevel(logging.DEBUG if verbose else logging.INFO)
    stream_handler.setFormatter(fmtter)

    logger.addHandler(file_handler)
    logger.addHandler(stream_handler)

    return logger


def main():
    """
    Run main function of benchmon-run
    """
    args = parse_args()

    os.makedirs(args.save_dir, exist_ok=True)
    logger = create_logger(save_dir=args.save_dir, verbose=args.verbose)

    logger.info("benchmon-run starts")

    args_str = ""
    for key, value in vars(args).items():
        args_str += f"\t--{key} {value}\n"
    logger.debug(f"benchmon-run arguments: \n{args_str}")

    get_benchmon_pid(logger)
    runmonitor = RunMonitor(args, logger)
    runmonitor.run()

    logger.info("benchmon-run stops")
    logger.info(
        f"Traces saved in: {os.path.realpath(args.save_dir)}/benchmon_traces_{HOSTNAME}"
    )
    logger.info(
        f"Full log file: {os.path.realpath(args.save_dir)}/benchmon_{HOSTNAME}.log"
    )


if __name__ == "__main__":
    main()
