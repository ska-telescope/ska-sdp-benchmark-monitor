#!/usr/bin/env python3
# filepath: /home/wangfeng/work/ska-sdp-benchmark-monitor/exec/benchmon-stop-grafana
import argparse
import json
import os
import signal
import socket
import sys
from pathlib import Path

def main():
    """
    Finds and stops the InfluxDB and Grafana processes managed by benchmon.
    """
    parser = argparse.ArgumentParser(description="Stop Benchmon Grafana/InfluxDB Stack")
    parser.add_argument(
        "--save-dir",
        type=Path,
        help="Base directory for traces. Defaults to current directory."
    )
    args = parser.parse_args()

    # --- Align directory logic with benchmon-run-grafana ---
    hostname = socket.gethostname()
    base_dir = args.save_dir if args.save_dir is not None else Path(".")
    traces_dir = base_dir / f"benchmon_traces_"
    runtime_dir = traces_dir / "grafana-data"
    pid_file = runtime_dir / "pids.json"

    if not pid_file.is_file():
        print(f"Error: PID file not found at {pid_file}", file=sys.stderr)
        print("Hint: Ensure you are in the correct directory or provide the correct --save-dir.", file=sys.stderr)
        sys.exit(1)

    print(f"Reading PID file from: {pid_file}")
    with open(pid_file, "r") as f:
        try:
            pids = json.load(f)
        except json.JSONDecodeError:
            print(f"Error: Could not decode PID file {pid_file}", file=sys.stderr)
            sys.exit(1)

    for service, pid in pids.items():
        print(f"Stopping {service} (PID: {pid})...")
        try:
            os.kill(pid, signal.SIGTERM)
            print(f"{service.capitalize()} stopped.")
        except ProcessLookupError:
            print(f"Warning: Process for {service} (PID: {pid}) not found. It might have already stopped.")
        except Exception as e:
            print(f"Error stopping {service} (PID: {pid}): {e}", file=sys.stderr)

    # Clean up pid file
    try:
        os.remove(pid_file)
        print(f"Removed PID file: {pid_file}")
    except OSError as e:
        print(f"Warning: Could not remove PID file: {e}", file=sys.stderr)

    print("\nMonitoring stack stopped.")

if __name__ == "__main__":
    main()