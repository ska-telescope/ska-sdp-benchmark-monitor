#!/usr/bin/env python3
"""Main Python script to visualize monitoring metrics"""

import argparse
import logging
import os
from datetime import datetime

from benchmon.visualization import BenchmonMNSyncVisualizer
from benchmon.visualization import BenchmonVisualizer


def parsing() -> argparse.Namespace:
    """
    Parse benchmonspc_visu arguments

    Returns:
        argparse.Namespace: Arguments namespace storing attributes
    """
    # Parser
    parser = argparse.ArgumentParser()

    # Repositories
    parser.add_argument("traces_repo", type=str, nargs="?", default="./", help="Traces repository path")
    parser.add_argument("--recursive", action="store_true", default=False)

    # System metrics
    parser.add_argument("--cpu", action="store_true", help="Visualize CPU")
    parser.add_argument("--cpu-all", action="store_true", help="Visualize all CPU cores")
    parser.add_argument("--cpu-freq", action="store_true", help="Visualize all CPU cores frequencies")
    parser.add_argument("--cpu-cores-full", type=str, default="", help="CPU cores to display")
    parser.add_argument("--cpu-cores-in", type=str, default="", help="CPU cores to display")
    parser.add_argument("--cpu-cores-out", type=str, default="", help="CPU cores to exclude")
    parser.add_argument("--mem", action="store_true", help="Visualize memory")
    parser.add_argument("--net", action="store_true", help="Visualize network activity")
    parser.add_argument("--net-all", action="store_true", help="Visualize network activity of all interfaces ")
    parser.add_argument("--net-rx-only", action="store_true", help="Visualize rx network only")
    parser.add_argument("--net-tx-only", action="store_true", help="Visualize tx network only")
    parser.add_argument("--net-data", action="store_true", help="Label network plot with total size of networked data")
    parser.add_argument("--disk", action="store_true", help="Visualize disk activity")
    parser.add_argument("--disk-iops", action="store_true", help="Visualize disk iops")
    parser.add_argument("--disk-rd-only", action="store_true", help="Visualize disk read activity only")
    parser.add_argument("--disk-wr-only", action="store_true", help="Visualize disk write activity only")
    parser.add_argument("--disk-data", action="store_true", help="Label disk plot with total size of operated data")
    parser.add_argument("--ib", action="store_true", help="Visualize infiniband activity")
    parser.add_argument("--sys", action="store_true", help="Visualize all system data")

    # Power profile
    parser.add_argument("--pow-g5k", action="store_true", help="Visualize g5k power")
    parser.add_argument("--pow", action="store_true", help="Visualize power")

    # Callstack
    parser.add_argument("--inline-call", action="store_true", help="Visualize callstack inline within monitoring")
    parser.add_argument("--inline-call-cmd", type=str, default="", help="Inline command to visualize")
    parser.add_argument("--call", action="store_true", help="Visualize callstack")
    parser.add_argument("--call-depth", type=int, default=1, help="Callstack depth level")
    parser.add_argument('--call-depths', type=str, default="", help="Comma-separated depth levels")
    parser.add_argument('--call-cmd', type=str, default="", help="Command to visualize")

    parser.add_argument("--annotate-with-log", type=str, default="", help="Annotate the plots with a given log file")

    # Time limits
    parser.add_argument("--start-time", type=str, help="Start time")
    parser.add_argument("--end-time", type=str, help="Start time")

    # Figures
    parser.add_argument("--interactive", action="store_true", help="Interactive visualization")
    parser.add_argument("--fig-path", type=str, help="Figure format")
    parser.add_argument("--fig-fmt", type=str, default="svg", help="Figure format")
    parser.add_argument("--fig-name", type=str, default="benchmon_fig", help="Figure name")
    parser.add_argument("--fig-dpi", type=str, default="unset", help="Quality of figure: low, medium, high")
    parser.add_argument("--fig-call-legend-ncol", type=int, default=8, help="Number of columns of call traces legend")
    parser.add_argument("--fig-width", type=float, default=25.6, help="Figure width")
    parser.add_argument("--fig-height-unit", type=float, default=3, help="Figure height unit for each subplot")
    parser.add_argument("--fig-xrange", type=int, default=25, help="Number of xticks on x-axis")
    parser.add_argument("--fig-yrange", type=int, default=11, help="Number of yticks on y-axis")

    # Enable verbosity
    parser.add_argument("--verbose", action="store_true", help="Enable debug information")
    parser.add_argument("--test", action="store_true", help="Test without reading dbs")

    args = parser.parse_args()

    return args


def create_logger(traces_repo: str, verbose: bool) -> logging.Logger:
    """
    Create logging manager

    Args:
        traces_repo (str) : Traces repository
        verbose     (bool): Enable verbosity

    Return:
        logging.Logger: The logger object
    """
    logger = logging.getLogger("benchmon_logger")
    logger.setLevel(logging.DEBUG)
    fmt = "<%(filename)s> [%(asctime)s] [%(levelname)s] %(message)s"
    datefmt = "%Y-%m-%d %H:%M:%S"
    fmtter = logging.Formatter(fmt=fmt, datefmt=datefmt)

    logfile = f"{traces_repo}/benchmon-visu_{int(datetime.now().timestamp())}.log"
    file_handler = logging.FileHandler(logfile)
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(fmtter)

    stream_handler = logging.StreamHandler()
    stream_handler.setLevel(logging.DEBUG if verbose else logging.INFO)
    stream_handler.setFormatter(fmtter)

    logger.addHandler(file_handler)
    logger.addHandler(stream_handler)

    return logger


def main():
    """
    Run main function
    """
    # Init
    args = parsing()
    traces_repo = args.traces_repo
    is_recursive = args.recursive

    # Create logging
    logger = create_logger(traces_repo=traces_repo, verbose=args.verbose)
    logger.info(f"benchmon-visu processes traces on {traces_repo}")

    args_str = "benchmon-visu arguments: \n"
    for key, value in vars(args).items():
        args_str += f"\t--{key.replace('_', '-')} {value}\n"
    logger.debug(f"{args_str}")

    traces_repos = []
    if args.test:
        pass
    elif is_recursive:
        for name in os.listdir(traces_repo):
            if os.path.isdir(os.path.join(traces_repo, name)) and "benchmon_traces" in name:
                traces_repos += [f"{traces_repo}/{name}"]
    else:
        traces_repos += [traces_repo]

    nodes_data = []
    for repo in traces_repos:
        nodes_data += [BenchmonVisualizer(args=args, logger=logger, traces_repo=repo)]
        nodes_data[-1].run_plots()

    if is_recursive:
        BenchmonMNSyncVisualizer(args, logger, nodes_data)

    logger.info("benchmon-visu closes")

    return 0


if __name__ == "__main__":
    main()
