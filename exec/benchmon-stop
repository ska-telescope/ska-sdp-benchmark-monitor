#!/usr/bin/bash

args=""
save_dir="./benchmon_savedir_${SLURM_JOB_ID}${OAR_JOB_ID}"
while [[ $# -gt 0 ]]; do
    case $1 in
        "-l" | "--level")
            level=$2
            shift 2
            ;;
        "-d" | "--save-dir")
            save_dir=$2
            shift 2
            ;;
        *)
            args="$args $1"
            shift 1
            ;;
    esac
done

benchmon_pid_file=./.benchmon-run_pid_${OAR_JOB_ID}${SLURM_JOB_ID}_$(hostname)
if [[ -f ${benchmon_pid_file} ]]
then
    pids=$(tr ',' ' ' < ${benchmon_pid_file})
    xargs -d',' -a ${benchmon_pid_file} kill -2
    while kill -0 "${pids[@]}" 2>/dev/null; do sleep 1; done
    rm -v ${benchmon_pid_file}
fi

traces_repo=$save_dir/benchmon_traces_$(hostname)
benchmon_visu=$(dirname $0)/benchmon-visu
benchmon_report=$(dirname $0)/benchmon-report
benchmon_template=$(python -c 'import benchmon; print(benchmon.__path__.pop())')/report/template.md
if [[ $level == 0 ]]; then
    $benchmon_visu --cpu --mem --net --disk --fig-fmt png,svg --fig-dpi medium --fig-name benchmon_figure_overview $traces_repo
    $benchmon_visu --cpu --cpu-all --cpu-freq --mem --net --net-all --net-data --disk --disk-data --disk-iops --fig-fmt png,svg --fig-dpi medium --fig-name benchmon_figure_detailed $traces_repo

elif [[ $level == 1 ]]; then
    $benchmon_visu --cpu --mem --net --disk --inline-call --fig-fmt png,svg --fig-dpi medium --fig-name benchmon_figure_overview $traces_repo
    $benchmon_visu --cpu --cpu-all --cpu-freq --mem --net --net-all --net-data --disk --disk-data --disk-iops --inline-call --fig-fmt png,svg --fig-dpi medium --fig-name benchmon_figure_detailed $traces_repo # --pow


elif [[ $level == 2 ]]; then
    $benchmon_visu --cpu --mem --net --disk --inline-call --call --call-depth 4 --fig-fmt png,svg --fig-dpi medium --fig-name benchmon_figure_overview $traces_repo
    $benchmon_visu --cpu --cpu-all --cpu-freq --mem --net --net-all --net-data --disk --disk-data --disk-iops --inline-call --call --call-depth 4 --fig-fmt png,svg --fig-dpi medium --fig-name benchmon_figure_detailed $traces_repo # --pow
fi

$benchmon_report --software-report "$save_dir/swmon_merged.json" --hardware-report "$save_dir/hwmon_merged.json" \
                 --figure-path "$traces_repo/benchmon_figure_detailed.png"                                       \
                 --ps-report "$traces_repo/timing_mapping_report.csv"                                            \
                 --template "$benchmon_template"                                                                 \
                 --output "$traces_repo/benchmon_report.md"
python3 -m pandoc read $traces_repo/benchmon_report.md | python -m pandoc write -f html -o $traces_repo/benchmon_report.html